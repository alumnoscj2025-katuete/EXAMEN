<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Examen de Arte - 7¬∫ Grado</title>
<style>
  body { font-family: Arial; margin: 10px; background: #f9f9f9; }
  h1 { text-align: center; color: #333; }
  .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,.1); }
  select, input[type=text], button { width: 100%; padding: 10px; margin-top: 8px; border-radius: 8px; border: 1px solid #ccc; font-size: 16px; }
  label { display: block; margin: 6px 0; font-size: 15px; }
  #btnEnviar { background-color: #2196F3; color: white; margin-top: 10px; }
  #btnPDF { background-color: #4CAF50; color: white; margin-top: 10px; display:none; }
  @media (max-width: 600px) { select, input[type=text], button { font-size: 18px; padding: 12px; } }
</style>
</head>
<body>

<h1>üìò Examen de Arte ‚Äì 7¬∫ Grado</h1>

<div class="card">
  <h3>Seleccion√° tus datos</h3>
  <select id="selTurno"><option value="">-- Turno --</option></select>
  <select id="selGrado"><option value="">-- Grado --</option></select>
  <select id="selEst"><option value="">-- Estudiante --</option></select>
  <select id="selMat"><option value="">-- Materia --</option></select>
</div>

<div id="preguntas"></div>

<button id="btnEnviar">üì§ Enviar Respuestas</button>
<button id="btnPDF">üíæ Generar PDF</button>

<script>
const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbzTTvI2QYoBAHcoQKY8YDftGirkD6c5FTUZ0PBkhp83iyJjUFNd0OgKLG4l7iMtu3az/exec";

const selTurno = document.getElementById("selTurno");
const selGrado = document.getElementById("selGrado");
const selEst   = document.getElementById("selEst");
const selMat   = document.getElementById("selMat");
const btnEnviar= document.getElementById("btnEnviar");
const btnPDF   = document.getElementById("btnPDF");
const divPreg  = document.getElementById("preguntas");

// Arreglo de preguntas
const examenData = [
  {tipo:"multiple", pregunta:"1. ¬øQu√© movimiento art√≠stico se caracteriza por la representaci√≥n de los objetos desde m√∫ltiples puntos de vista, fragmentando la figura y usando formas geom√©tricas?", opciones:["a) Impresionismo","b) Surrealismo","c) Cubismo","d) Expresionismo"], correcta:"c) Cubismo"},
  {tipo:"multiple", pregunta:"2. ¬øQu√© famoso artista del Renacimiento pint√≥ 'La Mona Lisa' y 'La √öltima Cena'?", opciones:["a) Vincent van Gogh","b) Salvador Dal√≠","c) Leonardo da Vinci","d) Claude Monet"], correcta:"c) Leonardo da Vinci"},
  {tipo:"multiple", pregunta:"3. ¬øCu√°l de los siguientes no es un elemento fundamental del arte?", opciones:["a) L√≠nea","b) Sabor","c) Forma","d) Textura"], correcta:"b) Sabor"},
  {tipo:"multiple", pregunta:"4. ¬øQu√© t√©cnica de pintura utiliza pigmentos disueltos en agua y aglutinados con goma ar√°biga, resultando en colores transparentes?", opciones:["a) Pintura al √≥leo","b) T√©mpera","c) Acuarela","d) Acr√≠lico"], correcta:"c) Acuarela"},
  {tipo:"multiple", pregunta:"5. ¬øQu√© famosa artista mexicana es conocida por sus autorretratos que exploran temas de identidad y dolor?", opciones:["a) Mar√≠a Izquierdo","b) Remedios Varo","c) Leonora Carrington","d) Frida Kahlo"], correcta:"d) Frida Kahlo"},
  {tipo:"vf", pregunta:"6. ¬øEs la escultura una t√©cnica que crea obras de arte bidimensionales?", correcta:"Falso"},
  {tipo:"vf", pregunta:"7. ¬øEs cierto que el color verde se forma al mezclar los colores primarios rojo y amarillo?", correcta:"Falso"},
  {tipo:"vf", pregunta:"8. ¬øEs Antoni Gaud√≠ un famoso arquitecto espa√±ol conocido por su estilo Modernista?", correcta:"Verdadero"},
  {tipo:"vf", pregunta:"9. ¬øLa famosa obra 'La noche estrellada' fue pintada por el artista mexicano Diego Rivera?", correcta:"Falso"},
  {tipo:"vf", pregunta:"10. El Grito de Edvard Munch es una de las obras m√°s representativas del movimiento art√≠stico conocido como Surrealismo.", correcta:"Falso"}
];

window.onload = () => {
  cargarConfig();
  selTurno.onchange = cargarEstudiantes;
  selGrado.onchange = cargarEstudiantes;
  selMat.onchange = mostrarPreguntas;
  btnEnviar.onclick = enviarRespuestas;
  btnPDF.onclick = generarPDF;
};

async function cargarConfig() {
  try {
    const res = await fetch(`${URL_SCRIPT}?action=config`);
    const cfg = await res.json();
    llenarSelect(selTurno, cfg.turnos);
    llenarSelect(selGrado, cfg.grados);
    llenarSelect(selMat, cfg.materias);
  } catch(err) { alert("‚ùå Error al cargar configuraci√≥n: "+err.message); }
}

function llenarSelect(select, arr){
  select.innerHTML = "";
  const def = select===selTurno?"-- Turno --": select===selGrado?"-- Grado --":"-- Materia --";
  select.appendChild(new Option(def,""));
  arr.forEach(v=>select.appendChild(new Option(v,v)));
}

async function cargarEstudiantes(){
  const g = selGrado.value, t = selTurno.value;
  if(!g||!t) return;
  try{
    const res = await fetch(`${URL_SCRIPT}?action=estudiantes&grado=${g}&turno=${t}`);
    const lst = await res.json();
    selEst.innerHTML = "";
    selEst.appendChild(new Option("-- Estudiante --",""));
    lst.forEach(e=>selEst.appendChild(new Option(e.nombre,e.nombre)));
  }catch(err){ alert("‚ùå Error al cargar estudiantes: "+err.message); }
}

function mostrarPreguntas(){
  divPreg.innerHTML = "";
  examenData.forEach((q,i)=>{
    let html = `<div class="card"><b>${q.pregunta}</b>`;
    if(q.tipo==="multiple"){
      q.opciones.forEach(opt=>{
        html += `<label><input type="radio" name="preg${i}" value="${opt}"> ${opt}</label>`;
      });
    } else if(q.tipo==="vf"){
      html += `<label><input type="radio" name="preg${i}" value="Verdadero"> Verdadero</label>`;
      html += `<label><input type="radio" name="preg${i}" value="Falso"> Falso</label>`;
    } else if(q.tipo==="texto"){
      html += `<input type="text" name="preg${i}">`;
    }
    html += `</div>`;
    divPreg.insertAdjacentHTML("beforeend", html);
  });
}

async function enviarRespuestas(){
  const est = selEst.value, mat = selMat.value, g = selGrado.value, t = selTurno.value;
  if(!est||!mat) return alert("‚ö†Ô∏è Complet√° todos los campos");

  const preguntas = examenData.map(q=>q.pregunta);
  const correctas = examenData.map(q=>q.correcta);
  const respuestas = examenData.map((_,i)=>{
    const sel = document.querySelector(`input[name='preg${i}']:checked`);
    if(sel) return sel.value;
    const txt = document.querySelector(`input[name='preg${i}']`);
    return txt? txt.value : "";
  });

  let nota = 0;
  respuestas.forEach((r,i)=>{ if((r||"").trim().toLowerCase()=== (correctas[i]||"").trim().toLowerCase()) nota++; });

  const payload = {estudiante: est, grado: g, turno: t, materia: mat, preguntas, respuestas, correctas, nota};

  try{
    const res = await fetch(URL_SCRIPT,{
      method:"POST",
      headers:{"Content-Type":"text/plain"},
      body: JSON.stringify(payload)
    });
    const ok = await res.json();
    if(ok.status==="ok" || ok.success===true){
      alert(`‚úÖ Nota: ${nota}/${correctas.length}`);
      btnPDF.style.display="block";
    } else { alert("‚ùå Error al guardar respuestas en Sheets"); }
  }catch(err){ alert("‚ùå Error guardando respuestas. Revis√° la consola."); console.error(err); }
}

function generarPDF(){
  const contenido = divPreg.innerHTML;
  const win = window.open('','_blank','width=800,height=600');
  win.document.write(`<html><head><title>Examen PDF</title></head><body>`);
  win.document.write(`<h1>Examen de Arte</h1>`);
  win.document.write(`<h3>Estudiante: ${selEst.value}</h3>`);
  win.document.write(contenido);
  win.document.write('</body></html>');
  win.document.close();
  win.print();
}
</script>
</body>
</html>

